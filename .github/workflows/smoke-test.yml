name: Sentinel Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Sentinel Services
        run: docker compose build

      - name: Start Services
        run: docker compose up -d

      - name: Wait for API Readiness
        run: |
          echo "Waiting for XGBoost model to load into memory..."
          # Retries curl every 5s for up to 60s
          timeout 60s bash -c 'until curl -s localhost:8000/health; do sleep 5; done' || (docker compose logs && exit 1)

      - name: Run Inference Smoke Test
        run: |
          # We store the massive Cursor JSON in a variable for clarity
          PAYLOAD='{"features":{"Amt_to_Mean_Ratio":0.0,"C1":0.0,"C10":0.0,"C11":0.0,"C12":0.0,"C13":0.0,"C14":0.0,"C2":0.0,"C3":0.0,"C4":0.0,"C5":0.0,"C6":0.0,"C7":0.0,"C8":0.0,"C9":0.0,"D1":0.0,"D10":0.0,"D11":0.0,"D12":0.0,"D13":0.0,"D14":0.0,"D15":0.0,"D2":0.0,"D3":0.0,"D4":0.0,"D5":0.0,"D6":0.0,"D7":0.0,"D8":0.0,"D9":0.0,"DeviceInfo":0.0,"DeviceType":0.0,"M1":0.0,"M2":0.0,"M3":0.0,"M4":0.0,"M5":0.0,"M6":0.0,"M7":0.0,"M8":0.0,"M9":0.0,"P_emaildomain":0.0,"P_emaildomain_freq":0.0,"ProductCD":0.0,"R_emaildomain":0.0,"TransactionAmt":0.0,"V1":0.0,"V10":0.0,"V100":0.0,"V101":0.0,"V102":0.0,"V103":0.0,"V104":0.0,"V105":0.0,"V106":0.0,"V107":0.0,"V108":0.0,"V109":0.0,"V11":0.0,"V110":0.0,"V111":0.0,"V112":0.0,"V113":0.0,"V114":0.0,"V115":0.0,"V116":0.0,"V117":0.0,"V118":0.0,"V119":0.0,"V12":0.0,"V120":0.0,"V121":0.0,"V122":0.0,"V123":0.0,"V124":0.0,"V125":0.0,"V126":0.0,"V127":0.0,"V128":0.0,"V129":0.0,"V13":0.0,"V130":0.0,"V131":0.0,"V132":0.0,"V133":0.0,"V134":0.0,"V135":0.0,"V136":0.0,"V137":0.0,"V138":0.0,"V139":0.0,"V14":0.0,"V140":0.0,"V141":0.0,"V142":0.0,"V143":0.0,"V144":0.0,"V145":0.0,"V146":0.0,"V147":0.0,"V148":0.0,"V149":0.0,"V15":0.0,"V150":0.0,"V151":0.0,"V152":0.0,"V153":0.0,"V154":0.0,"V155":0.0,"V156":0.0,"V157":0.0,"V158":0.0,"V159":0.0,"V16":0.0,"V160":0.0,"V161":0.0,"V162":0.0,"V163":0.0,"V164":0.0,"V165":0.0,"V166":0.0,"V167":0.0,"V168":0.0,"V169":0.0,"V17":0.0,"V170":0.0,"V171":0.0,"V172":0.0,"V173":0.0,"V174":0.0,"V175":0.0,"V176":0.0,"V177":0.0,"V178":0.0,"V179":0.0,"V18":0.0,"V180":0.0,"V181":0.0,"V182":0.0,"V183":0.0,"V184":0.0,"V185":0.0,"V186":0.0,"V187":0.0,"V188":0.0,"V189":0.0,"V19":0.0,"V190":0.0,"V191":0.0,"V192":0.0,"V193":0.0,"V194":0.0,"V195":0.0,"V196":0.0,"V197":0.0,"V198":0.0,"V199":0.0,"V2":0.0,"V20":0.0,"V200":0.0,"V201":0.0,"V202":0.0,"V203":0.0,"V204":0.0,"V205":0.0,"V206":0.0,"V207":0.0,"V208":0.0,"V209":0.0,"V21":0.0,"V210":0.0,"V211":0.0,"V212":0.0,"V213":0.0,"V214":0.0,"V215":0.0,"V216":0.0,"V217":0.0,"V218":0.0,"V219":0.0,"V22":0.0,"V220":0.0,"V221":0.0,"V222":0.0,"V223":0.0,"V224":0.0,"V225":0.0,"V226":0.0,"V227":0.0,"V228":0.0,"V229":0.0,"V23":0.0,"V230":0.0,"V231":0.0,"V232":0.0,"V233":0.0,"V234":0.0,"V235":0.0,"V236":0.0,"V237":0.0,"V238":0.0,"V239":0.0,"V24":0.0,"V240":0.0,"V241":0.0,"V242":0.0,"V243":0.0,"V244":0.0,"V245":0.0,"V246":0.0,"V247":0.0,"V248":0.0,"V249":0.0,"V25":0.0,"V250":0.0,"V251":0.0,"V252":0.0,"V253":0.0,"V254":0.0,"V255":0.0,"V256":0.0,"V257":0.0,"V258":0.0,"V259":0.0,"V26":0.0,"V260":0.0,"V261":0.0,"V262":0.0,"V263":0.0,"V264":0.0,"V265":0.0,"V266":0.0,"V267":0.0,"V268":0.0,"V269":0.0,"V27":0.0,"V270":0.0,"V271":0.0,"V272":0.0,"V273":0.0,"V274":0.0,"V275":0.0,"V276":0.0,"V277":0.0,"V278":0.0,"V279":0.0,"V28":0.0,"V280":0.0,"V281":0.0,"V282":0.0,"V283":0.0,"V284":0.0,"V285":0.0,"V286":0.0,"V287":0.0,"V288":0.0,"V289":0.0,"V29":0.0,"V290":0.0,"V291":0.0,"V292":0.0,"V293":0.0,"V294":0.0,"V295":0.0,"V296":0.0,"V297":0.0,"V298":0.0,"V299":0.0,"V3":0.0,"V30":0.0,"V300":0.0,"V301":0.0,"V302":0.0,"V303":0.0,"V304":0.0,"V305":0.0,"V306":0.0,"V307":0.0,"V308":0.0,"V309":0.0,"V31":0.0,"V310":0.0,"V311":0.0,"V312":0.0,"V313":0.0,"V314":0.0,"V315":0.0,"V316":0.0,"V317":0.0,"V318":0.0,"V319":0.0,"V32":0.0,"V320":0.0,"V321":0.0,"V322":0.0,"V323":0.0,"V324":0.0,"V325":0.0,"V326":0.0,"V327":0.0,"V328":0.0,"V329":0.0,"V33":0.0,"V330":0.0,"V331":0.0,"V332":0.0,"V333":0.0,"V334":0.0,"V335":0.0,"V336":0.0,"V337":0.0,"V338":0.0,"V339":0.0,"V34":0.0,"V35":0.0,"V36":0.0,"V37":0.0,"V38":0.0,"V39":0.0,"V4":0.0,"V40":0.0,"V41":0.0,"V42":0.0,"V43":0.0,"V44":0.0,"V45":0.0,"V46":0.0,"V47":0.0,"V48":0.0,"V49":0.0,"V5":0.0,"V50":0.0,"V51":0.0,"V52":0.0,"V53":0.0,"V54":0.0,"V55":0.0,"V56":0.0,"V57":0.0,"V58":0.0,"V59":0.0,"V6":0.0,"V60":0.0,"V61":0.0,"V62":0.0,"V63":0.0,"V64":0.0,"V65":0.0,"V66":0.0,"V67":0.0,"V68":0.0,"V69":0.0,"V7":0.0,"V70":0.0,"V71":0.0,"V72":0.0,"V73":0.0,"V74":0.0,"V75":0.0,"V76":0.0,"V77":0.0,"V78":0.0,"V79":0.0,"V8":0.0,"V80":0.0,"V81":0.0,"V82":0.0,"V83":0.0,"V84":0.0,"V85":0.0,"V86":0.0,"V87":0.0,"V88":0.0,"V89":0.0,"V9":0.0,"V90":0.0,"V91":0.0,"V92":0.0,"V93":0.0,"V94":0.0,"V95":0.0,"V96":0.0,"V97":0.0,"V98":0.0,"V99":0.0,"addr1":0.0,"addr2":0.0,"card1":0.0,"card1_freq":0.0,"card2":0.0,"card3":0.0,"card4":0.0,"card5":0.0,"card6":0.0,"dist1":0.0,"dist2":0.0,"id_01":0.0,"id_02":0.0,"id_03":0.0,"id_04":0.0,"id_05":0.0,"id_06":0.0,"id_07":0.0,"id_08":0.0,"id_09":0.0,"id_10":0.0,"id_11":0.0,"id_12":0.0,"id_13":0.0,"id_14":0.0,"id_15":0.0,"id_16":0.0,"id_17":0.0,"id_18":0.0,"id_19":0.0,"id_20":0.0,"id_21":0.0,"id_22":0.0,"id_23":0.0,"id_24":0.0,"id_25":0.0,"id_26":0.0,"id_27":0.0,"id_28":0.0,"id_29":0.0,"id_30":0.0,"id_31":0.0,"id_32":0.0,"id_33":0.0,"id_34":0.0,"id_35":0.0,"id_36":0.0,"id_37":0.0,"id_38":0.0,"uid_TransactionAmt_mean_30d":0.0,"uid_TransactionFreq_24h":0.0}}'

          RESPONSE=$(curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD") 
          
          echo "API Response: $RESPONSE"
          
          if [[ $RESPONSE == *"fraud_probability"* ]]; then
            echo "Smoke test passed!"
          else
            echo "Smoke test failed: $RESPONSE"
            exit 1
          fi

      - name: Stop Services
        if: always()
        run: docker compose down